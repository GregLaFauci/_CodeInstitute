###  

### RENEWING A SUBSCRIPTION

To renew a subscription, we need to introduce the idea of *webhooks*, so that we
can pass information from Stripe to our website when events take place.

When Stripe takes a monthly subscription payment from our customer,
this triggers an event that Stripe will notify us of. It will send a POST http
request to a URL that we specify in our Stripe ‘Account settings \> Webhooks’
section, and this POST request will contain all of the data about the event in
JSON format. Conceptually, this is similar to having Stripe’s servers fill out a
form on our site, only we don’t need to have an actual form; but we will need to
set up a view to handle this POST request.

![](http://codeinstitute.wpengine.com/wp-content/uploads/2016/01/1452104894_image4.png)

To add the webhook endpoint (i.e., the URL of your website you would like the
JSON messages to be sent to), click ‘Add endpoint’.

![](http://codeinstitute.wpengine.com/wp-content/uploads/2016/01/1452104894_image5.png)

You’ll need to set this option once you’ve deployed your site. But for now there
isn’t a way to test your local version using Stripe’s own systems, so we’ll be
taking advantage of some other technology later.

You can create different endpoints for testing or live environments by selecting
the corresponding mode.

And finally, if you only want certain events to be reported to you, you can
individually select them. This is especially designed to keep the amount of
messages down to only the ones you’re interested in.

### HANDLING THE JSON POSTS

When Stripe sends data about events, it passes information about what type of
event it is. We’re specifically looking for an event
‘invoice.payment_succeeded’, which means the subscription was paid and we can
extend the user’s time limit ‘user.subscription_end’.

Let’s first take a look at what these events look like on our stripe account:

Log in to your account and click on *Events & Webhooks* to find a list of stripe
events and indeed webhooks. Select an *invoice paid* event. Once clicked you
should see something similar to the screenshot below. Notice that the event data
is JSON format. This info can be sent via a webhook to our application. In our
case letting us know that the payment went through successfully. We can then use
this to let our user know that all is well.

![](http://codeinstitute.wpengine.com/wp-content/uploads/2016/01/renewingsubscription.png)

We then write a view that corresponds to the hook we register on stripe.com . So
whenever an event is fired we can grab the event data.

 

Let’s create the view for our webhook now and call it *subscriptions_webhook()*:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
...
import datetime
import json
from django.views.decorators.csrf import csrf_exempt
from django.http import HttpResponse
from models import User
...
@csrf_exempt
def subscriptions_webhook(request):
    event_json = json.loads(request.body)
    # Verify the event by fetching it from Stripe
    try:
        # firstly verify this is a real event generated by Stripe.com
        # commented out for testing - uncomment when live
        # event = stripe.Event.retrieve(event_json['object']['id'])
        cust = event_json['object']['customer']
        paid = event_json['object']['paid']
        user = User.objects.get(stripe_id=cust)
        if user and paid:
            user.subscription_end = arrow.now().replace(weeks=+4).datetime  # 4 weeks from now
            user.save()
 
    except stripe.InvalidRequestError, e:
        return HttpResponse(status=404)
    return HttpResponse(status=200)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The first thing to note is that we’re using ‘\@csrf_exempt’ to stop Django from
blocking this call from Stripe. If we did not, then we would never receive the
JSON post and be able to respond.

Next, using the JSON module, we turn our `request.body` into a dict so we can
easily work with the values.

The first thing we need to do for security is to verify that this actually came
from Stripe, so we attempt to load the event from Stripe’s API. If that
succeeded, we know we have a valid event and can proceed!

   
This *won’t* work when testing on a localhost (the stripe webhook needs to point
to a domain or publicly available IP address) so we have it commented out for
testing.

After finding our user by the customer string in the event that matches our
stripe_id in our database, we then check if the user was found and they have
paid.

If all checks out OK, we can finally update the user’s subscription_end variable
and save.

The only additional change we need to make in our Django code is to add this
view to our **urls.py**file:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
...
urlpatterns = [
...
    url(r'^subscriptions_webhook/$', accounts_views.subscriptions_webhook, name='subscriptions_webhook'),
...
]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

### TESTING OUR WEBHOOK

As we don’t have a way to send tests straight from Stripe to us, we need to use
the ‘curl’ tool to send a fake ‘invoice.payment_succeeded’ event to our webhook
locally (note that the **curl**command is available on MacOS and LInux, but
isn’t available on Windows directly; to use it on Windows, use Git Bash).

To do that, we’ll cut, paste, and format a sample ‘invoice.payment_succeeded’
JSON post from the Stripe system and edit it to fit our needs (notice we also
added quotes to our keys and non-integer values):

 

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
{
  "object":
    {
        "id": "in_17j6BCK4oMdhkST3ArlcRYID",
        "object": "invoice",
        "amount_due": 999,
        "application_fee": null,
        "attempt_count": 1,
        "attempted": true,
        "charge": "ch_17j6BCK4oMdhkST3meBXlX06",
        "closed": true,
        "currency": "gbp",
        "customer": "cus_MY_CUSTOMER_ID",
        "date": 1456572250,
        "description": null,
        "discount": null,
        "ending_balance": 0,
        "forgiven": false,
        "lines": {
            "object": "list",
            "data":[
                {
                    "id": "sub_7z4Juj7UIkWOGV",
                    "object": "line_item",
                     "amount": 999,
                    "currency": "gbp",
                    "description": null,
                    "discountable": true,
                    "livemode": false,
                    "metadata": {},
                    "period": {
                        "start": 1456517913,
                        "end": 1456604313
                    },
                    "plan": {
                        "id": "REG_MONTHLY_",
                        "object": "plan",
                        "amount": 999,
                        "created": 1456571797,
                        "currency": "gbp",
                        "interval": "month",
                        "interval_count": 1,
                        "livemode": false,
                        "metadata": {},
                        "name": "Monthly Subscription",
                        "statement_descriptor": null,
                        "trial_period_days": null
                    },
                    "proration": false,
                    "quantity": 1,
                    "subscription": null,
                    "type": "subscription"
                }
            ],
            "has_more": false,
            "total_count": 1,
            "url": "/v1/invoices/in_17j6BCK4oMdhkST3ArlcRYID/lines"
        },
        "livemode": false,
        "metadata": {
        },
        "next_payment_attempt": null,
        "paid": true,
        "period_end": 1456572250,
        "period_start": 1456572250,
        "receipt_number": null,
        "starting_balance": 0,
        "statement_descriptor": null,
        "subscription": "sub_7z4Juj7UIkWOGV",
        "subtotal": 999,
        "tax": null,
        "tax_percent": null,
        "total": 999,
        "webhooks_delivered_at": null
    }
}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Here we simply swap out the value for the *customer* with the customer we want
to test (get this from the stripe event data for the customer you want to test)
and then we’re ready to use CURL to post the information to our URL!

To make this simple, we’ve made a shell script to automate it. If you’re from a
Windows background, you can think of these as batch files for the Linux
operating system. Create and save a file called *subscription_webhook.sh*. Add
the code below, but don’t forget to add your own *customer*:

 

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 curl -H "Content-Type: application/json" -X POST -d '
 {
  "object":
    {
        "id": "MY_EVENT_ID",
        "object": "invoice",
        "amount_due": 999,
        "application_fee": null,
        "attempt_count": 1,
        "attempted": true,
        "charge": "ch_17j6BCK4oMdhkST3meBXlX06",
        "closed": true,
        "currency": "gbp",
        "customer": "cus_MY_CUSTOMER_ID",
        "date": 1456572250,
        "description": null,
        "discount": null,
        "ending_balance": 0,
        "forgiven": false,
        "lines": {
            "object": "list",
             "data": [
                {
                    "id": "sub_7z4Juj7UIkWOGV",
                    "object": "line_item",
                     "amount": 999,
                    "currency": "gbp",
                    "description": null,
                    "discountable": true,
                    "livemode": false,
                    "metadata": {},
                    "period": {
                        "start": 1456517913,
                        "end": 1456604313
                    },
                    "plan": {
                        "id": "REG_MONTHLY_",
                        "object": "plan",
                        "amount": 999,
                        "created": 1456571797,
                        "currency": "gbp",
                        "interval": "month",
                        "interval_count": 1,
                        "livemode": false,
                        "metadata": {},
                        "name": "Monthly Subscription",
                        "statement_descriptor": null,
            "trial_period_days": null
                    },
                    "proration": false,
                    "quantity": 1,
                    "subscription": null,
                    "type": "subscription"
                }
            ],
            "has_more": false,
            "total_count": 1,
            "url": "/v1/invoices/in_17j6BCK4oMdhkST3ArlcRYID/lines"
        },
        "livemode": false,
        "metadata": {
        },
        "next_payment_attempt": null,
        "paid": true,
        "period_end": 1456572250,
        "period_start": 1456572250,
        "receipt_number": null,
        "starting_balance": 0,
        "statement_descriptor": null,
        "subscription": "sub_7z4Juj7UIkWOGV",
        "subtotal": 999,
        "tax": null,
        "tax_percent": null,
        "total": 999,
        "webhooks_delivered_at": null
    }
}' http://localhost:8000/subscriptions_webhook/
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To break that down to something more readable, let’s look at the basic CURL
command:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
curl -H "Content-Type: application/json" -X POST -d '<some json goes here>' http://localhost:8000/subscriptions_webhook/
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

We’re calling *curl* and setting the html header to JSON so that Django knows
this is not a html page.

Then we use -X to say that the information should be posted to the URL instead
of the default GET method that would be used.

After that, we add in the JSON we want to pass and finally the local URL for our
webhook. To run this script to the following:

Make sure your project is running.

Open a Bash window and type the following to run your script:

`sh subscription_webhook.sh`

   
This is a great way of testing your REST code during development, and we’ll be
using this method later to test other webhooks when we start looking into the
Django Rest Framework.

One thing we cannot fake is the test for the event object from Stripe being
real! So while you’re testing, remember to comment that line out until you know
the rest of the code is working.

Later, when you deploy code to production, you would probably use something like
this to include/exclude checks:

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
from django.conf import settings
…
if settings.DEBUG:
    event = stripe.Event.retrieve(event_json["id"])
...
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

That way, your production code only runs when it’s on the live server.

### SUMMARY

As you can see, subscriptions are a great way to allow access to a site and its
content – and with Stripe they’re simple to setup and manage.

You’ve also seen that working with Stripe has given a nice introduction to using
webhooks to communicate between other web services.

We’ll be using what we’ve learned here to build on in future lessons.

###  

### USEFUL RESOURCES

-   **curl manual page:** <https://curl.haxx.se/docs/manpage.html>

-   **webhooks:** <http://culttt.com/2014/01/22/webhooks/>

-   **stripe webhooks:** <https://stripe.com/docs/webhooks>

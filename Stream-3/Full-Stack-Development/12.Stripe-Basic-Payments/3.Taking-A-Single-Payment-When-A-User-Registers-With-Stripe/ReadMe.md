### TAKING A SINGLE PAYMENT WHEN A NEW USER REGISTERS

On the server/Django side of things, we now have enough to register our new user
and charge them an entry fee for our site, so let’s take a look at how we
accomplish that in our **register()** view inside **accounts/views.py**:

-   Lines 7-9 our additional imports including the stripe module and access to
    our settings.py file.

-   We import the settings and the stripe modules so we can access our
    STRIPE_SECRET and STRIPE_PUBLISHABLE. With those we can set Stripes api_key
    and create our ‘publishable’ template variable that we used earlier in our
    JavaScript when setting the ‘Stripe.publishableKey’.

-   So here we’re adding a few more lines of code to make the payment side of
    things work. Our registration() view has been updated to include the
    creation of a hard coded charge for \$9.99. For taking one-off payments, you
    should use the stripe.Charge.create class method. Notice that the amount is
    in units, so an amount of \$21.89 would be written here as 2189.

-   We also pass “USD” to signify that we want the user to pay in that currency.
    You can change this to whatever codes you require for your site.

-   A list of supported currencies are
    available [here](https://support.stripe.com/questions/which-currencies-does-stripe-support).

-   We also pass a description containing our user’s email address, so that when
    we look through our records on the Stripe website, we can see who made the
    payment. You can pass other pieces of information in this as you see fit.
    All this takes place if the form validation was successful and is done on
    lines 17-25.

-   The charge() method returns a customer object that contains a paid boolean
    field. We use this on line 28 to register the user if the payment went
    through OK.

-   On line 41 we create the args used to pass over to our register.html
    template. This is where the {{publishable}} variable gets assigned. We pass
    the token/id generated by our JavaScript call to the API so that Stripe will
    connect the payment to the card details they’ve already saved on their side.
    After calling this method, we should have a customer object returned
    containing the transaction details. The point we’re interested in is to
    check that they did pay. If they did, then we’re good to go! If the call
    creates an ‘stripe.error.CardError’ exception, then the card was declined.
    We should inform the user so they can use another.

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
from django.contrib import messages, auth
from django.contrib.auth.decorators import login_required
from accounts.forms import UserRegistrationForm, UserLoginForm
from django.core.urlresolvers import reverse
from django.shortcuts import render, redirect
from django.template.context_processors import csrf
from django.conf import settings
import datetime
import stripe
 
stripe.api_key = settings.STRIPE_SECRET
 
def register(request):
    if request.method == 'POST':
        form = UserRegistrationForm(request.POST)
        if form.is_valid():
            try:
                customer = stripe.Charge.create(
                        amount=999,
                        currency="USD",
                        description=form.cleaned_data['email'],
                        card=form.cleaned_data['stripe_id'],
                )
                if customer.paid:
                    form.save()
                    user = auth.authenticate(email=request.POST.get('email'),
                                             password=request.POST.get('password1'))
                    if user:
                        auth.login(request, user)
                        messages.success(request, "You have successfully registered")
                        return redirect(reverse('profile'))
                    else:
                        messages.error(request, "unable to log you in at this time!")
                else:
                    messages.error(request, "We were unable to take a payment with that card!")
            except stripe.error.CardError, e:
                messages.error(request, "Your card was declined!")
    else:
        today = datetime.date.today()
        form = UserRegistrationForm()
 
    args = {'form': form, 'publishable': settings.STRIPE_PUBLISHABLE}
    args.update(csrf(request))
 
    return render(request, 'register.html', args)
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

 

Nicely done! Now we’re almost ready to test. Before we do that, we’ll need to
migrate. Go ahead and run the following two commands:

`python manage.py makemigrations`

`python manage.py migrate`

And that’s it – we’re ready to test. Run the server and navigate to
localhost:8000 to register a new user and take payment.

 

### SUMMARY

In this Unit we’ve added the Stripe Payment Gateway to an application, modified
the UI and the Model of our application to capture payment details, passed them
to Stripe, and stored the token that Stripe returns.
